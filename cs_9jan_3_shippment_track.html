<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Copilot Agent ‚Äì Persistent UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f172a;
  --panel:#020617;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --primary:#0078d4;
  --danger:#dc2626;
  --user:#2563eb;
  --bot:#334155;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:var(--bg);
  color:var(--text);
  height:100vh;
}
.app{display:flex;height:100vh}

/* Sidebar */
.sidebar{
  width:240px;
  background:var(--panel);
  display:flex;
  flex-direction:column;
}
.sidebar h2{
  margin:0;
  padding:16px;
  font-size:16px;
  background:#020617;
}
.nav button{
  width:100%;
  padding:12px 16px;
  border:none;
  background:none;
  color:var(--text);
  text-align:left;
  cursor:pointer;
}
.nav button:hover,
.nav button.active{
  background:var(--card);
}
.nav .danger:hover{
  background:#450a0a;
}
.footer{
  padding:12px;
  font-size:11px;
  color:var(--muted);
  text-align:center;
}

/* Main */
.main{flex:1;display:flex;flex-direction:column}
header{background:var(--primary);padding:14px;font-weight:600}

/* Views */
.view{flex:1;display:none}
.view.active{display:flex}

/* Chat */
#chatView{flex-direction:column}
#messages{flex:1;padding:16px;overflow-y:auto}
.message{margin-bottom:12px;max-width:75%}
.user{margin-left:auto;text-align:right}
.user span{
  background:var(--user);
  padding:10px 14px;
  border-radius:18px 18px 4px 18px;
  display:inline-block;
}
.bot span{
  background:var(--bot);
  padding:10px 14px;
  border-radius:18px 18px 18px 4px;
  display:inline-block;
}
.typing{font-size:12px;color:var(--muted);margin:6px}

/* Input */
#inputArea{
  display:flex;
  gap:8px;
  padding:12px;
  border-top:1px solid #334155;
}
#inputArea input{
  flex:1;
  padding:10px;
  border-radius:6px;
  border:none;
}
#inputArea button{
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:0 18px;
  cursor:pointer;
}

/* Lists */
.list{padding:16px;overflow-y:auto}
.list-item{
  background:var(--card);
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
}

/* Analytics */
#analyticsView{padding:20px}
</style>
</head>

<body>
<div class="app">

  <div class="sidebar">
    <h2>Copilot Agent</h2>
    <div class="nav">
      <button class="active" onclick="switchView('chatView',this)">üí¨ Chat</button>
      <button onclick="switchView('historyView',this)">üïò History</button>
      <button onclick="switchView('savedView',this)">‚≠ê Saved</button>
      <button onclick="switchView('analyticsView',this)">üìä Analytics</button>
      <button class="danger" onclick="clearChat()">üßπ Clear Chat</button>
    </div>
    <div class="footer">Persistent Demo</div>
  </div>

  <div class="main">
    <header id="headerTitle">Chat</header>

    <div id="chatView" class="view active">
      <div id="messages"></div>
      <div id="inputArea">
        <input id="userMessage" placeholder="Type your message‚Ä¶" onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <div id="historyView" class="view">
      <div class="list" id="historyList"></div>
    </div>

    <div id="savedView" class="view">
      <div class="list" id="savedList"></div>
    </div>

    <div id="analyticsView" class="view">
      <canvas id="analyticsChart"></canvas>
    </div>
  </div>
</div>

<script>
const API_URL="https://0a5ed514b766e466aa09229bcd556e.44.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/bf62f4b77faf40d88b7b07ecc42ab674/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vKr3Jlb_QiOz1t2IQ9rBRG3oLDCwDAYB4kJsZ6i3_X4";

const CHAT_KEY="copilot_chat_history";
const SAVED_KEY="copilot_saved_messages";

const messages=document.getElementById('messages');
const userMessage=document.getElementById('userMessage');
const historyList=document.getElementById('historyList');
const savedList=document.getElementById('savedList');
const analyticsChart=document.getElementById('analyticsChart');
const headerTitle=document.getElementById('headerTitle');

let chatHistory=JSON.parse(localStorage.getItem(CHAT_KEY))||[];
let savedMessages=JSON.parse(localStorage.getItem(SAVED_KEY))||[];
let chart=null;

/* NAV */
function switchView(id,btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  headerTitle.innerText=btn.innerText;
}

/* CHAT */
function addMessage(sender,text){
  chatHistory.push({sender,text,time:new Date()});
  localStorage.setItem(CHAT_KEY,JSON.stringify(chatHistory));

  const div=document.createElement('div');
  div.className='message '+sender;
  const span=document.createElement('span');
  span.innerHTML=sender==='bot'?marked.parse(text):text;
  div.appendChild(span);

  if(sender==='bot'){
    span.title="Double-click to save";
    span.ondblclick=()=>saveMessage(text);
  }

  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
  renderHistory();
}

/* CLEAR CHAT */
function clearChat(){
  if(!confirm("Clear entire chat history? This cannot be undone.")) return;

  chatHistory=[];
  localStorage.removeItem(CHAT_KEY);

  messages.innerHTML='';
  historyList.innerHTML='';

  if(chart) chart.destroy();
}

/* SAVED */
function saveMessage(text){
  savedMessages.push({text,time:new Date()});
  localStorage.setItem(SAVED_KEY,JSON.stringify(savedMessages));
  renderSaved();
}
function renderSaved(){
  savedList.innerHTML='';
  savedMessages.forEach(m=>{
    const d=document.createElement('div');
    d.className='list-item';
    d.innerHTML=m.text;
    savedList.appendChild(d);
  });
}

/* HISTORY */
function renderHistory(){
  historyList.innerHTML='';
  chatHistory.slice().reverse().forEach(m=>{
    const d=document.createElement('div');
    d.className='list-item';
    d.innerHTML=`<b>${m.sender}</b><br>${m.text}`;
    historyList.appendChild(d);
  });
  renderAnalytics();
}

/* SEND */
async function sendMessage(){
  const text=userMessage.value.trim();
  if(!text)return;

  addMessage('user',text);
  userMessage.value='';

  const typing=document.createElement('div');
  typing.className='typing';
  typing.innerText='Copilot is typing‚Ä¶';
  messages.appendChild(typing);

  try{
    const r=await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userid:'demo',user_query:text})
    });
    const raw=await r.text();
    let reply=raw;
    try{reply=JSON.parse(raw).body||raw}catch{}
    typing.remove();
    addMessage('bot',reply);
  }catch{
    typing.remove();
    addMessage('bot','‚ö†Ô∏è Error calling agent');
  }
}

/* ANALYTICS */
function renderAnalytics(){
  const userCount=chatHistory.filter(m=>m.sender==='user').length;
  const botCount=chatHistory.filter(m=>m.sender==='bot').length;
  if(chart)chart.destroy();
  chart=new Chart(analyticsChart,{
    type:'bar',
    data:{
      labels:['User','Bot'],
      datasets:[{data:[userCount,botCount]}]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

/* INIT */
chatHistory.forEach(m=>addMessage(m.sender,m.text));
renderSaved();
</script>
</body>
</html>
